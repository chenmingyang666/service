<!DOCTYPE>
<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../css/layui.css">
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../css/font-awesome.min.css" rel="stylesheet">

    <!-- 暂时别加main.css -->
    <title>添加项目信息</title>
    <style>
        .site-title fieldset {
            border: none;
            padding: 0;
            border-top: 1px solid #eee;
        }

        .site-title fieldset legend {
            margin-left: 20px;
            padding: 0 10px;
            font-size: 22px;
            font-weight: 300;
        }

        .layui-laypage-right {
            float: right !important;
        }

        .layui-form-label {
            width: 100px;
        }

        .layui-card-body .layui-form-label {
            text-align: left;
        }

        .layui-word-aux {
            color: red!important;
        }
        .layui-form-item{
            display: block
        }
    </style>

    <script src="../../js/layui.js"></script>
    <script src="../../js/lay/modules/jquery.js"></script>
    <script src="../../js/global.js"></script>
    <script src="../../js/tool.js"></script>
</head>

<body>
    
    <form class="layui-form" lay-filter="searchBox">
        <div class="layui-fluid">
            <div class="layui-row layui-col-space15">
                <div class="layui-form-item" style="border:1px solid #f6f6f6;">
                    <!-- <div class="layui-card-header">新增项目信息</div> -->
                    <div class="layui-card-body" style="padding: 15px;">
                        <div class="layui-form-item">
                            <label class="layui-form-label">项目名称：</label>
                            <div class="layui-input-inline" style="width: 50%">
                                <input type="text" name="name" id="pjtName" lay-verify="required" placeholder="输入名称"
                                    autocomplete="off" class="layui-input">
                            </div>
                            <div class="layui-form-mid layui-word-aux">*</div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">项目编号：</label>
                            <div class="layui-input-inline">
                                <input type="text" name="contract" placeholder="输入项目编号" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">项目周期：</label>
                            <div class="layui-inline">
                                <div class="layui-input-inline">
                                    <input type="text" name="startTime" class="layui-input" id="beginTime" placeholder="开始日期"
                                        autocomplete="off" lay-key="1">
                                </div>
                                <div class="layui-form-mid">
                                    -
                                </div>
                                <div class="layui-input-inline">
                                    <input type="text" name="endTime" class="layui-input" id="endTime" placeholder="结束日期"
                                        autocomplete="off" lay-key="2">
                                </div>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">营业时间：</label>
                            <div class="layui-inline">
                                <div class="layui-input-inline">
                                    <input type="text" name="workTime" class="layui-input" id="beginTime" placeholder="开始日期"
                                        autocomplete="off" lay-key="1">
                                </div>
                                <div class="layui-form-mid"><i class="fa fa-plus addFunc addTime"></i></div>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">负责人：</label>
                            <div class="layui-input-inline">
                                <input type="text" name="principal" lay-verify="required" placeholder="输入负责人"
                                    autocomplete="off" class="layui-input">
                            </div>
                            <div class="layui-form-mid layui-word-aux">*</div>
                            <label class="layui-form-label">联系方式：</label>
                            <div class="layui-input-inline">
                                <input type="text" name="principlePhone" lay-verify="required|phone" placeholder="输入负责人电话"
                                    autocomplete="off" class="layui-input">
                            </div>
                            <div class="layui-form-mid layui-word-aux">*</div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">维护人员：</label>
                            <div class="layui-input-inline">
                                <input type="text" name="principal" lay-verify="required" placeholder="输入维护人员"
                                    autocomplete="off" class="layui-input">
                            </div>
                            <div class="layui-form-mid layui-word-aux">*</div>
                            <label class="layui-form-label">联系方式：</label>
                            <div class="layui-input-inline">
                                <input type="text" name="principlePhone" lay-verify="required|phone" placeholder="输入维护人员电话"
                                    autocomplete="off" class="layui-input">
                            </div>
                            <div class="layui-form-mid layui-word-aux">*</div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">联系方式：</label>
                            <div class="layui-input-inline" style="width: 50%">
                                <input type="text" name="phone" lay-verify="required|phone" placeholder="输入联系方式"
                                    autocomplete="off" class="layui-input">
                            </div>
                            <div class="layui-form-mid layui-word-aux">*</div>
                        </div>

                        <div class="layui-form-item">
                            <label class="layui-form-label" style="text-align: left;">学校/社区：</label>
                            <!-- <div class="layui-input-inline" style="width: 50%">
                                <input type="text" name="community" placeholder="输入学校/社区" autocomplete="off" class="layui-input"
                                    lay-verify="required">
                            </div> -->
                            <div class="layui-input-inline">
                                <select name="province" lay-filter="province" class="province" lay-verify="required">
                                    <option value="">请选择省</option>
                                </select>
                            </div>
                            <div class="layui-input-inline">
                                <select name="city" lay-filter="city" disabled lay-verify="required">
                                    <option value="">请选择市</option>
                                </select>
                            </div>
                            <div class="layui-input-inline">
                                <select name="area" lay-filter="area" disabled lay-verify="required">
                                    <option value="">请选择县/区</option>
                                </select>
                            </div>

                            <div class="layui-input-inline">
                                <select name="community" lay-filter="community" disabled lay-verify="required">
                                    <option value="">请选择学校/社区</option>
                                </select>

                            </div>
                            <div class="layui-form-mid layui-word-aux">*</div>

                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">校区/地址：</label>
                            <div class="layui-input-inline" style="width: 50%">
                                <input type="text" name="address" placeholder="输入项目校区/地址" autocomplete="off" class="layui-input"
                                    lay-verify="required">
                            </div>
                            <div class="layui-form-mid layui-word-aux">*</div>
                            <div class="layui-form-mid"><i class="fa fa-plus addFunc addAddress"></i></div>
                            <div class="layui-form-mid"><i class="fa fa-minus addFunc removeAddress"></i></div>
                        </div>
                    </div>
                    <div class="layui-form-item" style="overflow: hidden;border:1px solid #f6f6f6;text-align: center">
                        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                        <button class="layui-btn layui-btn-danger" lay-submit lay-filter="searchBox">添加</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <script>
        layui.use(['form', 'table', 'jquery', 'laytpl', 'layer', 'laydate', 'common', 'address','main'], function () {
            var table = layui.table,
                $ = layui.jquery,
                layer = layui.layer,
                laytpl = layui.laytpl,
                laydate = layui.laydate,
                common = layui.common,
                address = layui.address(),
                form = layui.form;
            var url = location.href;
            let urlData = parseURL(url);
            if (urlData) {
                if (urlData.isTrue) {
                    $('.back').show();
                }

            };
            $('.removeAddress').hide();
            $('body').on('click', '.back', function () {
                window.history.back();
            }).on('click', '.addAddress', function () {
                $(this).parent().parent().find('.layui-input-inline').append(
                    '<input type="text" name="community" placeholder="输入项目校区/地址" autocomplete="off" class="layui-input" lay-verify="required">'
                );
                if ($(this).parent().parent().find('.layui-input-inline input').length > 1) {
                    $('.removeAddress').show();
                }
            }).on('click', '.removeAddress', function () {
                $(this).parent().parent().find('.layui-input-inline').children().last().remove()
                if ($(this).parent().parent().find('.layui-input-inline input').length == 1) {
                    $('.removeAddress').hide();

                }
            }).on('click', '.addTime', function () {
                initModal('新增营业时间','addHour.html')
            });

            form.render();
            // 日期
            laydate.render({
                elem: '#beginTime',
                type: 'datetime',
                format: 'yyyy-MM-dd HH:mm:ss',
                theme: '#393D49',
            });
            laydate.render({
                elem: '#endTime',
                type: 'datetime',
                format: 'yyyy-MM-dd HH:mm:ss',
                theme: '#393D49',
            });
            // 监听完区县然后加载学校
            form.on('select(area)', function (data) {
                $("select[name=community]").removeAttr("disabled");
                form.render();
                getSchool();
            });
            // 获取学校信息
            function getSchool() {
                var data = {
                    'province': $('select[name="province"]').siblings(
                        "div.layui-form-select").find(
                        'dl dd.layui-this').text(),
                    'city': $('select[name="city"]').siblings(
                        "div.layui-form-select").find(
                        'dl dd.layui-this').text(),
                    'area': $('select[name="area"]').siblings(
                        "div.layui-form-select").find(
                        'dl dd.layui-this').text(),
                };
                common.getSchoolList(data, function (res) {

                    $('select[name=community]').html('');
                    res.data.forEach(ele => {
                        $('select[name="community"]').append('<option value=' + ele.name +
                            ' data-address=' + ele.address +
                            ' data-province=' + ele.province +
                            ' data-city=' + ele.city +
                            ' data-area=' + ele.area + '>' + ele.name + '</option>')
                    });
                    form.render()
                })
            };
            form.on('submit(searchBox)', function (data) {
                if (data.field.community == '') {
                    layer.msg('请选择学校')
                } else {
                    parent.layer.open({
                        content: '确定保存项目信息?',
                        btn: ['确定', '取消'],
                        fixed: true,
                        offset: '40%',
                        yes: function (index, layero) {
                            //do something
                            common.addProjectInfo(data.field, function (res) {
                                if (res.code == 200) {
                                    parent.layer.confirm('保存成功，继续添加项目信息?', {
                                        icon: 3,
                                        title: '提示',
                                        fixed: true,
                                        offset: '40%',
                                        btn: ['继续添加', '返回项目列表'],
                                        yes: function (index) {
                                            parent.layer.close();
                                            window.location.reload();
                                        },
                                        btn2: function (index) {
                                            parent.layer.closeAll()
                                            // window.location.href =
                                            //     'pages/Project/info.html';
                                        }
                                    });
                                } else {
                                    if (res.message != null || res.message != '') {
                                        layer.msg(res.message);
                                    } else {
                                        layer.msg('保存失败');
                                    }
                                
                                }
                            })
                        },
                        btn2: function (index) {
                            parent.layer.close()

                        },
                       
                    });
                }


                return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
            });







        });
    </script>
</body>

</html>
<!DOCTYPE>
<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../css/layui.css">
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../css/font-awesome.min.css" rel="stylesheet">
    <title>编辑设备</title>
    <style>
        .layui-form-checkbox span{
            height: auto;
        }
        .site-title fieldset {
            border: none;
            padding: 0;
            border-top: 1px solid #eee;
        }

        .site-title fieldset legend {
            margin-left: 20px;
            padding: 0 10px;
            font-size: 22px;
            font-weight: 300;
        }

        .layui-laypage-right {
            float: right !important;
        }

        .layui-form-label {
            width: 150px;
        }

        .layui-word-aux {
            color: red
        }
        .makeAbled.disabled{
            color: #d2d2d2 !important;
    cursor: not-allowed !important;
    display: block;
    z-index: 10000;
        }
    </style>

    <script src="../../js/layui.js"></script>
    <!-- <script src="../../js/jquery.min.js"></script> -->
    <script src="../../js/global.js"></script>
    <script src="../../js/tool.js"></script>
    <!-- <script src="../../js/bootstrap.min.js"></script> -->
    <!-- <script src="../../js/bootstrap-suggest.min.js"></script> -->
</head>

<body>
    <form class="layui-form" lay-filter="searchBox">
        <div class="layui-fluid">
            <div class="layui-row layui-col-space15">
                <div class="layui-card" style="border:1px solid #f6f6f6;">
                    <!-- <div class="layui-card-header">编辑设备</div> -->
                    <div class="layui-card-body" style="padding: 15px;display: flex;">
                        <div class="layui-col-md8">
                            <div class="layui-form-item">
                                <label class="layui-form-label">设备名称：</label>
                                <div class="layui-input-inline" style="width: 50%;">
                                    <input type="tel" name="devName" lay-verify="required" autocomplete="off" class="layui-input">
                                </div>
                                <div class="layui-form-mid layui-word-aux">*必填</div>
                            </div>
                            <span class="makeAbled">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">设备分类：</label>
                                    <div class="layui-input-inline" style="width: 50%;">
                                        <select name="cate" lay-filter="cate" id="cate" lay-verify="">
                                        </select>
                                    </div>
                                    <div class="layui-form-mid layui-word-aux">*必填</div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">主机品牌：</label>
                                    <div class="layui-input-inline" style="width: 50%;">
                                        <select name="brandName" lay-filter="brandName" id="brandName" lay-verify="">
                                        </select>
                                    </div>
                                    <div class="layui-form-mid layui-word-aux">*必填</div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">主机型号：</label>
                                    <div class="layui-input-inline" style="width: 50%;">
                                        <select name="brandCode" lay-filter="brandCode" id="brandCode" lay-verify="">
                                        </select>
                                    </div>
                                    <div class="layui-form-mid layui-word-aux">*必填</div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">主机编号：</label>
                                    <div class="showPingtai">
                                        <div class="layui-input-inline" style="width: 50%;">
                                            <select name="eqptId" id="eqptId" lay-filter="eqptId">
                                                <option value="">请选择</option>
                                            </select>
                                        </div>
                                        <div class="layui-form-mid layui-word-aux">*必填</div>
                                    </div>
                                    <!-- <div class="showSelf" style="display: none">
                                    <div class="layui-input-inline" style="width: 50%;">
                                        <input type="text" name="number" autocomplete="off" class="layui-input">
                                    </div>
                                    <div class="layui-form-mid layui-word-aux">*必填</div>
                                </div>
                                <div class="layui-btn-container layui-input-inline">
                                    <a class="layui-btn layui-btn-primary layui-btn-danger layui-btn-xs showPingtaibtn">平台</a>
                                    <a class="layui-btn  layui-btn-primary layui-btn-xs showSelfbtn">自有</a>
                                </div> -->
                                </div>
                            </span>
                            <div class="layui-form-item">
                                <label class="layui-form-label">设备点名称：</label>
                                <div class="layui-input-inline" style="width: 50%;">
                                    <select name="locateId" id="locateId" lay-filter="locateId" lay-verify="">
                                        <option value="">请选择</option>

                                    </select>
                                </div>
                                <div class="layui-form-mid layui-word-aux">*必填</div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">楼层：</label>
                                <div class="layui-input-inline" style="width: 50%;">
                                    <input class="layui-input" name="floorNo" id="floorNo" lay-filter="floorNo" lay-verify="">
                                         
                                </div>
                                <div class="layui-form-mid layui-word-aux">*必填</div>
                            </div>
                        </div>
                        <div class="layui-col-md7">
                                <div class="layui-form-item wulianwang hide">
                                        <label class="layui-form-label">物联网卡号：</label>
                                        <div class="layui-input-inline" style="width: 50%;">
                                                <input type="text" name="simCode" placeholder="输入自有物联卡卡号" id="simSelf" class="layui-input">
                                            </div>
                                        </div>
                            <!-- <div class="layui-form-item">
                                <label class="layui-form-label">物联网卡号：</label>
                                <div class="showPingtai">

                                    <div class="layui-input-inline" style="width: 50%;">
                                        <select name="simId" id="simId" lay-filter="simcard">
                                            <option value="">请选择</option>
                                        </select>
                                    </div>

                                </div>
                                <div class="showSelf" style="display: none">
                                    <div class="layui-input-inline" style="width: 50%;">
                                        <input type="text" name="simCode" placeholder="输入自有物联卡卡号" id="simSelf" class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-form-mid layui-word-aux">*必填</div>
                                <div class="layui-btn-container layui-input-inline">
                                    <a class="layui-btn layui-btn-primary layui-btn-danger layui-btn-xs showPingtaibtn">平台</a>
                                    <a class="layui-btn  layui-btn-primary layui-btn-xs showSelfbtn">自有</a>
                                </div>
                            </div> -->
                            <div class="layui-form-item" id="showMainBoard">
                                <label class="layui-form-label">主板编号：</label>
                                <div class="layui-input-inline" style="width: 50%; height: 50px;">
                                    <select name="imeiId" lay-filter="imei" id="imei" lay-verify="">
                                        <option value="">请选择</option>
                                    </select>
                                </div>
                                <div class="layui-form-mid layui-word-aux">*必填</div>
                            </div>
                            <!-- <div class="layui-form-item" id="showMainBoard">
                                    <label class="layui-form-label">控制板编号：</label>
                                    <div class="layui-input-inline" style="width: 50%; height: 50px;">
                                        <select name="ctrlNumber" lay-filter="ctrlNumber" id="ctrlNumber" lay-verify="">
                                            <option value="">请选择</option>
                                        </select>
                                    </div>
                                    <div class="layui-form-mid layui-word-aux">*必填</div>
                                </div> -->

                            <!-- 槽位号 -->
                            <div class="layui-form-item" id="ports" style="display: none;">
                                <label class="layui-form-label">端口（槽位）：</label>
                                <div class="layui-input-inline" id="portsAll" style="width: 50%; height: 50px;">

                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">二维码编号：</label>
                                <div class="layui-input-inline" style="width: 50%;">
                                    <select name="qrCode" lay-filter="qrCode" lay-verify="" id="qrCode">
                                        <option value="">请选择</option>

                                    </select>
                                </div>
                                <div class="layui-form-mid layui-word-aux">*必填</div>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="layui-card" style="overflow: hidden;border:1px solid #f6f6f6;text-align: center">
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                    <button class="layui-btn layui-btn-danger" lay-submit lay-filter="searchBox">保存</button>
                </div>
            </div>
        </div>
    </form>
    <script>
        layui.use(['form', 'table', 'jquery', 'laytpl', 'layer', 'common'], function () {
            var table = layui.table,
                $ = layui.jquery,
                layer = layui.layer,
                laytpl = layui.laytpl,
                form = layui.form,
                common = layui.common,
                simId, qrId, rid, locateId, number, eqptId, imeiId,imeiNumber, portsArr;
            var url = location.href;
            // 此处为layui的bug，我想监听form(cate)的下拉列表事件，但是在页面上可能是作用域问题所以监听不到，只能如此
            (function ($) {
                var pca = {};
                pca.keys = {};
                pca.ckeys = {};
                pca.init = function (initData, province, city, area, initprovince, initcity, initarea) { //jQuery选择器, 省-市-区
                    if (!province || !$(province).length)
                        return;
                    $(province).html('');
                    $(province).append('<option value="" selected>请选择设备分类</option>');
                    for (var i in initData) {

                        $(province).append('<option value=' + initData[i].name + '>' +
                            initData[i].name + '</option>');
                        pca.keys[initData[i].name] = initData[i];
                    }
                    form.render();
                    if (initprovince)
                        $(province).next().find('[lay-value="' + initprovince + '"]').click();
                    if (!city || !$(city).length)
                        return;
                    pca.formRender(city);
                    form.on('select(cate)', function (data) {
                        if (data.value == '') {
                            $(city)
                                .next()
                                .find('dl dd')
                                .eq(0)
                                .click();
                        } else {
                            var cs = pca.keys[
                                $(data.elem)
                                .find('option[value=' + data.value + ']')
                                .text()
                            ];
                        };
                        if (data.value == '吹风机') {
                            // 吹风机默认4个端口
                            var initHtml = '';
                            for (var i = 0; i < 4; i++) {
                                initHtml +=
                                    '<input type="checkbox"  name="ports" value="' + (i + 1) +
                                    '" title="' +
                                    (i + 1) + '号" lay-skin="primary">'
                            }
                            $('#portsAll').html(initHtml);
                            $('#ports').show();
                            $('#portsAll input[name="ports"]').each(function () {
                                console.log($(this))
                            })
                        } else if (data.value == '充电桩') {
                            // 充电桩默认10个端口
                            var initHtml = '';
                            for (var i = 0; i < 10; i++) {
                                initHtml += '<input type="checkbox"  name="ports" value="' + (i +
                                        1) + '" title="' +
                                    (i + 1) + '号" lay-skin="primary">'
                            }
                            $('#portsAll').html(initHtml);
                            $('#ports').show();
                            $('#portsAll input[name="ports"]').each(function () {
                                var that = $(this);

                                if (portsArr.indexOf(Number(that.val())) >= 0) {

                                    $(this).attr('checked', 'checked');
                                }
                            });

                            form.render();
                        } else {
                            $('#ports').hide();
                        };

                        $(city).html('');
                        $(city).append('<option value="" selected>请选择设备品牌</option>');
                        if (cs) {
                            cs = cs.child;
                            for (var i in cs) {
                                $(city).append('<option>' + cs[i].name + '</option>');
                                pca.ckeys[cs[i].name] = cs[i];
                            }
                            $(city)
                                .find('option:eq(1)')
                                .attr('selected', true);
                        }
                        form.render();
                        $(city)
                            .next()
                            .find('.layui-this')
                            .removeClass('layui-this')
                            .click();
                        pca.formHidden('cate', data.value);
                    });
                    if (initprovince)
                        $(province).next().find('[lay-value="' + initprovince + '"]').click();
                    if (initcity)
                        $(city).next().find('[lay-value="' + initcity + '"]').click();
                    if (!area || !$(area).length)
                        return;
                    pca.formRender(area);
                    form.on('select(brandName)', function (data) {
                        var cs = pca.ckeys[data.value];
                        $(area).html('');
                        $(area).append('<option value="" selected>请选择设备型号</option>');
                        if (cs) {
                            cs = cs.child;
                            for (var i in cs) {
                                $(area).append('<option value=' + cs[i].id + '>' + cs[i].name +
                                    '</option>');
                            }
                            $(area)
                                .find('option:eq(1)')
                                .attr('selected', true);
                        }
                        form.render();
                        $(area)
                            .next()
                            .find('.layui-this')
                            .removeClass('layui-this')
                            .click();
                        pca.formHidden('brandName', data.value);
                    });
                    form.on('select(brandCode)', function (data) {
                        pca.formHidden('brandCode', data.value);
                        useDevice(data.value);
                        $('.makeAbled').addClass('disabled');
                        $('.makeAbled').find('select').attr('disabled','disabled');
                        form.render();
                    });
                    if (initprovince)
                        $(province).next().find('[lay-value="' + initprovince + '"]').click();
                    if (initcity)
                        $(city).next().find('[lay-value="' + initcity + '"]').click();
                    if (initarea)
                        $(area).next().find('[lay-value="' + initarea + '"]').click();
                }
                pca.formRender = function (obj) {
                    $(obj).html('');
                    // $(obj).append('<option>全部</option>');
                    form.render();
                }
                pca.formHidden = function (obj, val) {
                    if (!$('#pca-hide-' + obj).length)
                        $('body').append('<input id="pca-hide-' + obj + '" type="hidden" value="' + val +
                            '" />');
                    else
                        $('#pca-hide-' + obj).val(val);
                }
                window.pca = pca;
                return pca;
            })($);
            $('body').on('click', '.showPingtaibtn', function () {
                $(this).addClass('layui-btn-danger').siblings('a').removeClass('layui-btn-danger');
                $(this).parent().parent().find('.showPingtai').show().siblings('.showSelf').hide();
            }).on('click', '.showSelfbtn', function () {
                $(this).addClass('layui-btn-danger').siblings('a').removeClass('layui-btn-danger');
                $(this).parent().parent().find('.showSelf').show().siblings('.showPingtai').hide();
            });
            var trData = parseURL(url);
            common.getSingDeviceInfo(trData.id, function (res) {
                console.log(res);
                form.val("searchBox", {
                    "devName": res.data.devName,
                    'cate': res.data.cate,
                    'brandname': res.data.brandname,
                    'brand_code': res.data.brand_code,
                    'floorNo': res.data.floorNo,
                });
                form.render();
                deviceId = res.data.id;
                qrId = res.data.qrid;
                portsArr = res.data.ports;
                locateId = res.data.locateId;
                eqptId = res.data.eqptId;
                imeiId = res.data.imeiId;
                imeiNumber = res.data.imeiNumber;
                // 如果有物联网网卡
                if(res.data.simCode!=null){
                    $('.wulianwang').addClass('layui-disabled');
                }else{
                    $('.wulianwang').hide();
                }
                // common.getSimDropList(function (resSim) {
                //     console.log(resSim);
                //     if (res.data.source == 0) {
                //         $('#simId').html('');
                //         resSim.data.forEach(function (ele, index) {
                //             if (ele.simCode == res.data.sim_id) {
                //                 $('#simId').append("<option value=" + ele.id +
                //                     " selected>" + ele.simCode +
                //                     "</option>");
                //             } else {
                //                 $('#simId').append("<option value=" + ele.id + ">" +
                //                     ele.simCode +
                //                     "</option>");
                //             }
                //         });
                //         form.render();
                //     } else {
                //         resSim.data.forEach(function (ele, index) {
                //             if (ele.simCode == res.data.sim_id) {
                //                 $('#simId').append("<option value=" + ele.id +
                //                     " selected>" + ele.simCode +
                //                     "</option>");
                //             } else {
                //                 $('#simId').append("<option value=" + ele.id + ">" +
                //                     ele.simCode +
                //                     "</option>");
                //             }
                //         });
                //         form.render();
                //     }
                // });
                // 品牌的3级联动
                common.getDeviceLinked(function (res1) {
                    console.log(res1);
                    pca.init(res1.data, 'select[name=cate]', 'select[name=brandName]',
                        'select[name=brandCode]', res.data.cate, res.data.brand,
                        res.data.modelId);
                    form.render();
                });
                // 二维码
                common.getQrDropList(function (res2) {
                    console.log(res2);
                    res2.data.forEach(function (ele, index) {
                        if (res.data.qrId == ele.id) {
                            $('#qrCode').append("<option value=" + ele.id +
                                " selected>" + ele.qrCode +
                                "</option>");
                        } else {
                            $('#qrCode').append("<option value=" + ele.id + ">" + ele.qrCode +
                                "</option>");
                        }

                    });
                    form.render();
                });
                // 主机编号
                $('#eqptId').html("<option value='"+res.data.eqptId+"'>" + res.data.eqptNumber + "</option>");
                $('#imei').html("<option value=''>" + res.data.imeiNumber + "</option>");
                // 设备点下拉列表
                common.getLocateDropList(function (res3) {
                    console.log(res3);
                    res3.data.forEach(function (ele, index) {
                        if (res.data.locateId == ele.id) {
                            $('#locateId').append("<option value=" + ele.id +
                                " selected>" + ele.name +
                                "</option>");
                        } else {
                            $('#locateId').append("<option value=" + ele.id + ">" + ele
                                .name +
                                "</option>");
                        }
                    });
                    form.render();
                });
                form.render();
                //    source   0：平台 1：服务商
                // if (res.data.simOwned == 0) {
                //     // 物联卡下拉列表

                //     $('#simId').parents('.layui-form-item').find('.showPingtaibtn').click();
                //     form.render()
                // } else {

                //     $('#simSelf').parents('.layui-form-item').find('.showSelfbtn').click();
                //     $('#simSelf').val(res.data.simCode);
                // };
                // if (res.data.eqptOwned == 0) {

                //     $('#eqptId').parents('.layui-form-item').find('.showPingtaibtn').click();
                //     form.render();
                // } else {

                //     $('#eqptId').parents('.layui-form-item').find('.showSelfbtn').click();
                //     $('input[name="number"]').val(res.data.number);
                // };

            });
            
            function useDevice(data) {
                // 主机下拉列表（编辑不可变）
                // common.getHostList(data, function (res) {
                //     console.log(res);
                //     if (res.data.length > 0) {
                //         $('#eqptId').html("<option value=''></option>");
                //         res.data.forEach(function (ele, index) {

                //             if (eqptId == ele.id) {
                //                 $('#eqptId').append("<option value=" + ele.id +
                //                     " selected>" + ele.number +
                //                     "</option>");
                //             } else {
                //                 $('#eqptId').append("<option value=" + ele.id +
                //                     ">" + ele.number +
                //                     "</option>");
                //             }
                //             form.render();
                //         });
                //     } else {
                //         $('#eqptId').html("<option value=''></option>");
                //         form.render();
                //     }
                // });
                // 获取主板下拉列表内容
                common.getMBDropList(data, function (res) {
                    console.log(res.data);
                    if (res.data.length > 0) {
                        $('#imei').html('<option>请选择</option>');
                        $('#imei').append("<option value=" + imeiId +
                                    " selected>" + imeiNumber +
                                    "</option>");
                        res.data.forEach(function (ele) {
                            if (imeiId == ele.id) {
                                $('#imei').append("<option value=" + imeiId +
                                    " selected>" + imeiNumber +
                                    "</option>");
                            } else {
                                $('#imei').append("<option value=" + ele.id +
                                    ">" + ele.imei +
                                    "</option>");
                            }

                        })
                        form.render();
                    } else {
                        $('#imei').html('<option>请选择</option>');
                        form.render();
                    }

                });
            };
            // useDevice();

            form.on('select(simCard)', function (data) {
                simId = data.value;
            });
            form.on('select(qrCode)', function (data) {
                qrId = data.value;
            });
            form.on('select(locateId)', function (data) {
                locateId = data.value;
            });
            form.on('select(number)', function (data) {
                // common.getBindByNumber(data.value, function (res) {
                //     var data = res.data;
                //     console.log(data);
                //     if ($.isEmptyObject(data)) {
                //         $('#simId').find('option[selected]').remove();
                //         $('#qrCode').find('option[selected]').remove();
                //         $('#locateId').find('option[selected]').remove();
                //         $('#simId').removeAttr('disabled');
                //         $('#qrCode').removeAttr('disabled');
                //         $('#locateId').removeAttr('disabled');
                //         form.render();
                //     } else {
                //         if (!$('select#simId').siblings("div.layui-form-select").find('dl dd')
                //             .is('[lay-value=' + data.simId + ']') && pingtai) {
                //             $('#simId').append("<option value='" + data.simId +
                //                 "' selected >" + data.simCode +
                //                 "</option>");
                //             form.render();
                //         } else {
                //             $('select#simId').siblings("div.layui-form-select").find(
                //                 'dl dd[lay-value=' +
                //                 data.simCode + ']').click();
                //             form.render();
                //         }
                //         if (!$('select#qrCode').siblings("div.layui-form-select").find('dl dd')
                //             .is('[lay-value=' +
                //                 data.qrId + ']')) {
                //             $('#qrCode').append("<option value='" + data.qrId + "'selected >" +
                //                 data.qrCode +
                //                 "</option>");
                //             form.render()

                //         } else {
                //             $('select#qrCode').siblings("div.layui-form-select").find(
                //                 'dl dd[lay-value=' +
                //                 data.qrId + ']').click()
                //             form.render()
                //         }
                //         if (!$('select#locateId').siblings("div.layui-form-select").find(
                //                 'dl dd').is('[lay-value=' +
                //                 data.locateId + ']')) {
                //             $('#locateId').append("<option value='" + data.locateId +
                //                 "'selected >" + data.locateName +
                //                 "</option>");
                //             form.render()

                //         } else {
                //             $('select#locateId').siblings("div.layui-form-select").find(
                //                 'dl dd[lay-value=' +
                //                 data.locateId + ']').click();
                //             form.render()
                //         }
                //         form.render();
                //     }
                // })
            });
            form.on('submit(searchBox)', function (data) {
                data.field.id=trData.id;
                data.field.qrId = data.field.qrCode;
                data.field.qrCode=$('#qrCode').siblings("div.layui-form-select").find('.layui-this').text();;
                data.field.locateId = locateId;
                // 0：平台 1：服务商
                // 主机ID归属
                if ($('select#eqptId').next('.showSelf').is(':hidden')) {
                    data.field.eqptOwned = 0;
                    data.field.eqptId = $('#eqptId').siblings("div.layui-form-select").find(
                        'dl dd.layui-this').text();
                } else {
                    delete data.field.simId;
                    data.field.number = $('input[name="number"]').val();
                    data.field.eqptOwned = 1;
                };
                // 物联网卡归属
                if ($('#simId').next('.showSelf').is(':hidden')) {
                    data.field.simOwned = 0;
                    data.field.simCode = $('#simId').siblings("div.layui-form-select").find(
                        'dl dd.layui-this').text();
                } else {
                    data.field.simOwned = 1;
                    data.field.simCode = $('input[name="simCode"]').val();
                }
                // 槽位处理
                if (data.field.cate == '吹风机' || data.field.cate == '充电桩') {
                    var a = [];
                    $('input[name="ports"]').each(function (e) {
                        if ($(this).next('.layui-unselect').is('.layui-form-checked')) {
                            a.push($(this).val())
                        }
                    });
                    data.field.ports = a.toString();
                } else {
                    data.field.ports = '1'
                }
                delete data.field.brandName;
                data.field.modelId = data.field.brandCode;
                delete data.field.brandCode;
                delete data.field.eqptOwned;
                delete data.field.simOwned;
                console.log(JSON.stringify(data.field));
                layer.open({
                    content: '确定保存编辑内容?',
                    btn: ['确定', '取消'],
                    yes: function (index, layero) {
                         common.updateDeviceInfo(data.field, function (res) {
                            if (res.code == 200) { 
                                layer.confirm('保存成功，继续编辑设备?', {
                                    icon: 3,
                                    title: '提示',
                                    btn: ['确定', '返回列表'],
                                    yes: function (index) {
                                        layer.close(index);
                                    },
                                    btn2: function (index) {
                                        layer.close(index);
                                        parent.layer.closeAll();
                                        // window.location.href =
                                        //     'pages/Device/list.html';
                                    }
                                });
                            } else {
                                if (res.message != null || res.message != '') {
                                    layer.msg(res.message);
                                } else {
                                    layer.msg('保存失败');
                                }
                            }
                        });
                    },
                    
                });
                return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
            });
           
        });
    </script>
</body>

</html>
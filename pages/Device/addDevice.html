<!DOCTYPE>
<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../css/layui.css">
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../css/bootstrap.min.css">
    <title>添加设备</title>
    <style>
        .layui-form-checkbox span{
            height: auto;
        }
        .site-title fieldset {
            border: none;
            padding: 0;
            border-top: 1px solid #eee;
        }

        .site-title fieldset legend {
            margin-left: 20px;
            padding: 0 10px;
            font-size: 22px;
            font-weight: 300;
        }

        .layui-laypage-right {
            float: right !important;
        }

        .layui-form-label {
            width: 135px;
        }

        .layui-word-aux {
            color: red
        }
        .layui-side-menu,
        .layadmin-pagetabs .layui-tab-title li:after,
        .layadmin-pagetabs .layui-tab-title li.layui-this:after,
        .layui-layer-admin .layui-layer-title,
        .layadmin-side-shrink .layui-side-menu .layui-nav>.layui-nav-item>.layui-nav-child {
            background-color: #20222A !important;
        }

        .layui-nav-tree .layui-this,
        .layui-nav-tree .layui-this>a,
        .layui-nav-tree .layui-nav-child dd.layui-this,
        .layui-nav-tree .layui-nav-child dd.layui-this a {
            /* background-color: #009688 !important; */
            background-color: #1890ff !important;
        }

        .layui-nav-tree .layui-nav-bar {
            width: 5px;
            height: 0;
            background-color: #1890ff !important;
        }

        .layui-nav .layui-this:after,
        .layui-nav-bar,
        .layui-nav-tree .layui-nav-itemed:after {
            position: absolute;
            left: 0;
            top: 0;
            width: 0;
            height: 5px;
            background-color: #1890ff !important;
            transition: all .2s;
            -webkit-transition: all .2s;
        }

        .layui-layout-admin .layui-logo {
            background-color: #20222A !important;
        }

        .layui-laypage .layui-laypage-curr .layui-laypage-em {
            background-color: #1890ff !important;
        }

        .layui-form-select dl dd.layui-this {
            background-color: #1890ff !important;
            color: #fff;
        }
    </style>
    <script src="../../js/layui.js"></script>
    <script src="../../js/global.js"></script>
    <script src="../../js/tool.js"></script>
</head>

<body>

    <form class="layui-form" lay-filter="searchBox">
        <div class="layui-fluid">
            <div class="layui-row layui-col-space15">
                <div class="layui-card" style="border:1px solid #f6f6f6;">
                    <!-- <div class="layui-card-header">添加设备</div> -->
                    <div class="layui-card-body" style="padding: 15px;display: flex;">
                        <div class="layui-col-md8">
                            <div class="layui-form-item">
                                <label class="layui-form-label">设备名称：</label>
                                <div class="layui-input-inline" style="width: 50%;">
                                    <input type="tel" name="devName" lay-verify="required" autocomplete="off" class="layui-input">
                                    <input type="text" name="isEntry" class="layui-input hide">
                                </div>
                                <div class="layui-form-mid layui-word-aux">*必填</div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">设备分类：</label>
                                <div class="layui-input-inline" style="width: 50%;">
                                    <select name="cate" lay-filter="cate" id="cate" lay-verify="">
                                    </select>
                                </div>
                                <div class="layui-form-mid layui-word-aux">*必填</div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">主机品牌：</label>
                                <div class="layui-input-inline" style="width: 50%;">
                                    <select name="brandName" lay-filter="brandName" id="brandName" lay-verify="">
                                    </select>
                                </div>
                                <div class="layui-form-mid layui-word-aux">*必填</div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">主机型号：</label>
                                <div class="layui-input-inline" style="width: 50%;">
                                    <select name="brandCode" lay-filter="brandCode" id="brandCode" lay-verify="">
                                    </select>
                                </div>
                                <div class="layui-form-mid layui-word-aux">*必填</div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">主机编号：</label>
                                <div class="showPingtai">
                                    <div class="layui-input-inline" style="width: 50%;">
                                        <select name="eqptId" id="eqptId" lay-filter="eqptId">
                                            <option value="">请选择</option>
                                        </select>
                                    </div>
                                    <div class="layui-form-mid layui-word-aux">*必填</div>
                                </div>
                                <!-- <div class="showSelf" style="display: none">
                                    <div class="layui-input-inline" style="width: 50%;">
                                        <input type="text" name="number" autocomplete="off" class="layui-input">
                                    </div>
                                    <div class="layui-form-mid layui-word-aux">*必填</div>
                                </div>
                                <div class="layui-btn-container layui-input-inline">
                                    <a class="layui-btn layui-btn-primary layui-btn-danger layui-btn-xs showPingtaibtn">平台</a>
                                    <a class="layui-btn  layui-btn-primary layui-btn-xs showSelfbtn">自有</a>
                                </div> -->
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">设备点名称：</label>
                                <div class="layui-input-inline" style="width: 50%;">
                                    <select name="locateId" id="locateId" lay-filter="locateId" lay-verify="">
                                        <option value="">请选择</option>
                                    </select>
                                </div>
                                <div class="layui-form-mid layui-word-aux">*必填</div>
                            </div>
                            <div class="layui-form-item">

                                <label class="layui-form-label w50">楼号：</label>
                                <div class="layui-input-inline" style="width: 100px">
                                    <input class="layui-input" name="buildingNo" lay-verify="required">

                                </div>
                                <label class="layui-form-label">楼层：</label>
                                <div class="layui-input-inline" style="width: 100px;">
                                    <input class="layui-input" name="floorNo" id="floorNo" lay-filter="floorNo"
                                        lay-verify="required">

                                </div>
                                <div class="layui-form-mid layui-word-aux">*必填</div>
                            </div>
                        </div>
                        <div class="layui-col-md7">
                            <!-- <div class="layui-form-item">
                                <label class="layui-form-label">物联网卡号：</label>
                                <div class="showPingtai">

                                    <div class="layui-input-inline" style="width: 50%;">
                                        <select name="simId" id="simId" lay-filter="simcard">
                                            <option value="">请选择</option>
                                        </select>
                                    </div>

                                </div>
                                <div class="showSelf" style="display: none">
                                    <div class="layui-input-inline" style="width: 50%;">
                                        <input type="text" name="simCode" placeholder="输入自有物联卡卡号" id="simSelf" class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-form-mid layui-word-aux">*必填</div>
                                <div class="layui-btn-container layui-input-inline">
                                    <a class="layui-btn layui-btn-primary layui-btn-danger layui-btn-xs showPingtaibtn">平台</a>
                                    <a class="layui-btn  layui-btn-primary layui-btn-xs showSelfbtn">自有</a>
                                </div>
                            </div> -->
                            <div class="layui-form-item" id="showMainBoard">
                                <label class="layui-form-label">主板编号：</label>
                                <div class="layui-input-inline" style="width: 50%; height: 50px;">
                                    <select name="imeiId" lay-filter="imei" id="imei" lay-verify="">
                                        <option value="">请选择</option>
                                    </select>
                                </div>
                                <div class="layui-form-mid layui-word-aux">*必填</div>
                            </div>
                            <!-- <div class="layui-form-item" id="showMainBoard">
                                <label class="layui-form-label">控制板编号：</label>
                                <div class="layui-input-inline" style="width: 50%; height: 50px;">
                                    <select name="ctrlNumber" lay-filter="ctrlNumber" id="ctrlNumber" lay-verify="">
                                        <option value="">请选择</option>
                                    </select>
                                </div>
                                <div class="layui-form-mid layui-word-aux">*必填</div>
                            </div> -->

                            <!-- 槽位号 -->
                            <div class="layui-form-item" id="ports" style="display: none;">
                                <label class="layui-form-label">端口（槽位）：</label>
                                <div class="layui-input-inline" id="portsAll" style="width: 50%; height: 50px;">

                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">二维码编号：</label>
                                <div class="layui-input-inline" style="width: 50%;">
                                    <select name="qrCode" lay-filter="qrCode" lay-verify="" id="qrCode">
                                        <option value="">请选择</option>

                                    </select>
                                </div>
                                <div class="layui-form-mid layui-word-aux">*必填</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-card" style="overflow: hidden;border:1px solid #f6f6f6;text-align: center">
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                    <button class="layui-btn layui-btn-danger" lay-submit lay-filter="searchBox">保存</button>
                </div>
            </div>
        </div>
    </form>
    <script src="../../js/jquery.min.js"></script>
    <!-- <script src="../../js/bootstrap.min.js"></script>
    <script src="../../js/bootstrap-suggest.min.js"></script> -->
    <script>
        layui.use(['form', 'table', 'jquery', 'laytpl', 'layer', 'element', 'common'], function () {
            var table = layui.table,
                $ = layui.jquery,
                layer = layui.layer,
                laytpl = layui.laytpl,
                form = layui.form,
                element = layui.element,
                common = layui.common;
            var url = location.href,
                urlData = parseURL(url);
            if (urlData) {
                urlData.isEntry ? $('input[name="isEntry"]').val(urlData.isEntry) : '';
            }
            $('body').on('click', '.showPingtaibtn', function () {
                $(this).addClass('layui-btn-danger').siblings('a').removeClass('layui-btn-danger');
                $(this).parent().parent().find('.showPingtai').show().siblings('.showSelf').hide();
            }).on('click', '.showSelfbtn', function () {
                $(this).addClass('layui-btn-danger').siblings('a').removeClass('layui-btn-danger');
                $(this).parent().parent().find('.showSelf').show().siblings('.showPingtai').hide();
            });
            (function ($) {
                var pca = {};
                pca.keys = {};
                pca.ckeys = {};
                pca.init = function (initData, province, city, area, initprovince, initcity, initarea) { //jQuery选择器, 省-市-区
                    if (!province || !$(province).length)
                        return;
                    $(province).html('');
                    $(province).append('<option value="" selected>请选择设备分类</option>');
                    for (var i in initData) {
                        $(province).append('<option value=' + initData[i].name + '>' +
                            initData[i].name + '</option>');
                        pca.keys[initData[i].name] = initData[i];
                    }
                    form.render();
                    if (initprovince)
                        $(province).next().find('[lay-value="' + initprovince + '"]').click();
                    if (!city || !$(city).length)
                        return;
                    pca.formRender(city);
                    form.on('select(cate)', function (data) {
                        if (data.value == '') {
                            $(city)
                                .next()
                                .find('dl dd')
                                .eq(0)
                                .click();
                        } else {
                            var cs = pca.keys[
                                $(data.elem)
                                .find('option[value=' + data.value + ']')
                                .text()
                            ];
                        };
                        if (data.value == '吹风机') {
                            // 吹风机默认4个端口
                            var initHtml = '';
                            for (var i = 0; i < 4; i++) {
                                initHtml +=
                                    '<input type="checkbox"  name="ports" value="' + (i + 1) +
                                    '" title="' +
                                    (i + 1) + '号" lay-skin="primary">'
                            }

                            $('#portsAll').html(initHtml);
                            $('#ports').show();

                        } else if (data.value == '充电桩') {
                            // 充电桩默认10个端口
                            var initHtml = '';
                            for (var i = 0; i < 10; i++) {
                                initHtml += '<input type="checkbox"  name="ports" value="' + (i +
                                        1) + '" title="' +
                                    (i + 1) + '号" lay-skin="primary">'
                            };
                            $('#portsAll').html(initHtml);
                            $('#ports').show();
                        } else {
                            $('#ports').hide()
                        };
                        $(city).html('');
                        $(city).append('<option value="" selected>请选择设备品牌</option>');
                        if (cs) {
                            cs = cs.child;
                            for (var i in cs) {
                                $(city).append('<option>' + cs[i].name + '</option>');
                                pca.ckeys[cs[i].name] = cs[i];
                            }
                            $(city)
                                .find('option:eq(1)')
                                .attr('selected', true);
                        }
                        form.render();
                        $(city)
                            .next()
                            .find('.layui-this')
                            .removeClass('layui-this')
                            .click();
                        pca.formHidden('cate', data.value);
                    });
                    if (initprovince)
                        $(province).next().find('[lay-value="' + initprovince + '"]').click();
                    if (initcity)
                        $(city).next().find('[lay-value="' + initcity + '"]').click();
                    if (!area || !$(area).length)
                        return;
                    pca.formRender(area);
                    form.on('select(brandName)', function (data) {
                        var cs = pca.ckeys[data.value];
                        $(area).html('');
                        $(area).append('<option value="" selected>请选择设备型号</option>');
                        if (cs) {
                            cs = cs.child;
                            for (var i in cs) {
                                $(area).append('<option value=' + cs[i].id + '>' + cs[i].name +
                                    '</option>');
                            }
                            $(area)
                                .find('option:eq(1)')
                                .attr('selected', true);
                        }
                        form.render();
                        $(area)
                            .next()
                            .find('.layui-this')
                            .removeClass('layui-this')
                            .click();
                        pca.formHidden('brandName', data.value);
                    });
                    form.on('select(brandCode)', function (data) {
                        pca.formHidden('brandCode', data.value);
                        useDevice(data.value);

                    });
                    if (initprovince)
                        $(province).next().find('[lay-value="' + initprovince + '"]').click();
                    if (initcity)
                        $(city).next().find('[lay-value="' + initcity + '"]').click();
                    if (initarea)
                        $(area).next().find('[lay-value="' + initarea + '"]').click();
                }
                pca.formRender = function (obj) {
                    $(obj).html('');
                    // $(obj).append('<option>全部</option>');
                    form.render();
                }
                pca.formHidden = function (obj, val) {
                    if (!$('#pca-hide-' + obj).length)
                        $('body').append('<input id="pca-hide-' + obj + '" type="hidden" value="' + val +
                            '" />');
                    else
                        $('#pca-hide-' + obj).val(val);
                }

                window.pca = pca;
                return pca;
            })($)

            function useDevice(data) {

                // 主机下拉列表
                common.getHostList(data, function (res) {
                    console.log(res);
                    if (res.data.length > 0) {
                        $('#eqptId').html("<option value=''></option>");
                        res.data.forEach(function (ele, index) {
                            $('#eqptId').append("<option value=" + ele.id +
                                ">" + ele.number +
                                "</option>");
                            form.render();
                        });
                    } else {
                        $('#eqptId').html("<option value=''></option>");
                        form.render();
                    }

                });
                // 获取主板下拉列表内容
                common.getMBDropList(data, function (res) {
                    console.log(res.data);
                    $('#imei').html('<option>请选择</option>');
                    res.data.forEach(function (ele) {
                        $('#imei').append("<option value=" + ele.id +
                            ">" + ele.imei +
                            "</option>");
                    })
                    form.render();
                });
            };
            // 监听主板选择
            form.on('select(imei)', function (data) {
                // common.getBindByNumber(data.value, function (res) {
                //     // console.log(res);
                //     var data = res.data;
                //     if ($.isEmptyObject(data)) {
                //         $('#simId').find('option[selected]').remove();
                //         $('#qrCode').find('option[selected]').remove();
                //         $('#locateId').find('option[selected]').remove();
                //         $('#simId').removeAttr('disabled');
                //         $('#qrCode').removeAttr('disabled');
                //         $('#locateId').removeAttr('disabled');
                //         form.render();
                //     } else {
                //         if (!$('select#simId').siblings("div.layui-form-select").find('dl dd')
                //             .is('[lay-value=' +
                //                 data.simId + ']')) {
                //             $('#simId').append("<option value='" + data.simId +
                //                 "' selected >" + data.simCode +
                //                 "</option>");
                //         } else {
                //             $('select#simId').siblings("div.layui-form-select").find(
                //                 'dl dd[lay-value=' +
                //                 data.simCode + ']').click()
                //         }
                //         if (!$('select#qrCode').siblings("div.layui-form-select").find('dl dd')
                //             .is('[lay-value=' +
                //                 data.qrId + ']')) {
                //             $('#qrCode').append("<option value='" + data.qrId + "'selected >" +
                //                 data.qrCode +
                //                 "</option>");
                //         } else {
                //             $('select#qrCode').siblings("div.layui-form-select").find(
                //                 'dl dd[lay-value=' +
                //                 data.qrId + ']').click()
                //         }
                //         if (!$('select#locateId').siblings("div.layui-form-select").find(
                //                 'dl dd').is('[lay-value=' +
                //                 data.locateId + ']')) {
                //             $('#locateId').append("<option value='" + data.locateId +
                //                 "'selected >" + data.locateName +
                //                 "</option>");
                //         } else {
                //             $('select#locateId').siblings("div.layui-form-select").find(
                //                 'dl dd[lay-value=' +
                //                 data.locateId + ']').click()
                //         }
                //         $('#simId').attr('disabled', true);
                //         $('#qrCode').attr('disabled', true);
                //         $('#locateId').attr('disabled', true);
                //         form.render();
                //     }
                // })
            });
            // 拼配3级联动
            common.getDeviceLinked(function (res) {
                console.log(res);
                pca.init(res.data, 'select[name=cate]', 'select[name=brandName]',
                    'select[name=brandCode]', 'a', 'a', 'a');
            });
            // 物联卡下拉列表
            // common.getSimDropList(function (res) {
            //     // console.log(res);
            //     res.data.forEach(function (ele, index) {
            //         $('#simId').append("<option value=" + ele.id + ">" + ele.simCode +
            //             "</option>");
            //         form.render();
            //     });
            // });
            // 二维码下拉列表
            common.getQrDropList(function (res) {
                // console.log(res);
                res.data.forEach(function (ele, index) {
                    $('#qrCode').append("<option value=" + ele.id + ">" + ele.qrCode +
                        "</option>");
                    form.render();
                });
            });
            // 设备点下拉列表
            common.getLocateDropList(function (res) {
                // console.log(res);
                res.data.forEach(function (ele, index) {
                    $('#locateId').append("<option value=" + ele.id + ">" + ele.name +
                        "</option>");
                    form.render();
                });
            });
            // 引导式录入 向entry.html发成功消息回调
            function transData() {
                layer.msg('保存成功');
                var autoMessage = {
                    "sureDevice": true
                };
                window.parent.postMessage(autoMessage, '*');
            }
            // 表单提交
            form.on('submit(searchBox)', function (data) {
                // console.log(data.field);
                data.field.qrId = data.field.qrCode;
                data.field.qrCode = $('#qrCode').siblings("div.layui-form-select").find(
                    'dl dd.layui-this').text();
                //       0：平台 1：服务商
                // 主机ID归属
                if ($('input[name="number"]').parents('.showSelf').is(':hidden')) {
                    data.field.eqptOwned = 0;
                    delete data.field.number;
                } else {
                    delete data.field.simId;
                    data.field.number = $('input[name="number"]').val();
                    data.field.eqptOwned = 1;
                };
                // 物联网卡归属
                // if ($('#simId').parents('.showSelf').is(':hidden')) {
                //     data.field.simOwned = 0;
                //     data.field.simCode = $('#simId').siblings("div.layui-form-select").find(
                //         'dl dd.layui-this').text();
                // } else {
                //     data.field.simOwned = 1;
                //     data.field.simCode = $('input[name="simCode"]').val();
                // }
                // 槽位的处理
                if (data.field.cate == '吹风机' || data.field.cate == '充电桩') {
                    var a = [];
                    $('input[name="ports"]').each(function (e) {
                        if ($(this).next('.layui-unselect').is('.layui-form-checked')) {
                            a.push($(this).val())
                        }
                    });
                    data.field.ports = a.toString();
                } else {
                    data.field.ports = '1'
                }
                delete data.field.brandName;
                data.field.modelId = data.field.brandCode;
                delete data.field.brandCode;
                delete data.field.cate;
                console.log(data.field);
                layer.open({
                    content: '确定保存新设备?',
                    btn: ['确定', '取消'],
                    yes: function (index, layero) {
                        common.addDeviceInfo(data.field, function (res) {

                            if (res.code == 200) {
                                if (data.field.isEntry) {
                                    transData();
                                } else {
                                    layer.confirm('保存成功，继续添加设备?', {
                                        icon: 3,
                                        title: '提示',
                                        btn: ['继续添加', '返回设备列表'],
                                        yes: function (index) {
                                            layer.close(index);
                                        },
                                        btn2: function (index) {
                                            parent.layer.closeAll();
                                            parent.location.reload();
                                            // window.location.href =
                                            //     'pages/Device/list.html';
                                        }
                                    });
                                };
                                layer.close(index);

                            } else {
                                layer.close(index);
                                if (res.message != null || res.message != '') {
                                    layer.msg(res.message);
                                } else {
                                    layer.msg('保存失败');
                                }
                            }
                        })
                    },


                });
                return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
            });


        });
    </script>
</body>

</html>